<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Correlation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #fff;
    }
    h3 { color: #1976d2; margin-top: 0; }
    .group-title { font-weight: bold; margin-bottom: 10px; font-size: 16px; }
    .group-section { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #f7f7f7;}
    .column-list { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff;}
    .column-list label { display: block; margin-bottom: 8px; padding: 4px; cursor: pointer;}
    .column-list label:hover { background: #e3f2fd; }
    .method-section { margin-bottom: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px;}
    .actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;}
    button { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px;}
    button[type="submit"] { background: #1976d2; color: white; border-color: #1976d2;}
    button[type="submit"]:hover { background: #1565c0;}
    .error { color: #d32f2f; margin-top: 10px; padding: 8px; background: #ffebee; border-radius: 4px; display: none;}
    .info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px;}
    .popup-close { position: absolute; top: 12px; right: 16px; font-size: 20px; color: #555; cursor: pointer;}
    .popup-close:hover { color: #000;}
  </style>
</head>
<body>
  <h3>Correlation Analysis</h3>
  <div class="info">
    Select method and columns for analysis.<br>
    <b>Bivariate:</b> simple correlation; <b>Partial:</b> controls for extra variables; <b>Distances:</b> computes Euclidean distances.<br>
    You can select multiple columns for advanced methods.
  </div>

  <form id="correlationForm">
    <div class="method-section">
      <div style="font-weight: bold;">Analysis Type:</div>
      <label><input type="radio" name="cor_method" value="bivariate" checked> Bivariate (Pearson)</label>
      <label><input type="radio" name="cor_method" value="partial"> Partial</label>
      <label><input type="radio" name="cor_method" value="distances"> Distances (Case-wise)</label>
    </div>

    <div class="group-section">
      <div class="group-title">Variables Group 1:</div>
      <div class="column-list" id="columnList1"></div>
    </div>
    <div class="group-section">
      <div class="group-title">Variables Group 2 (optional):</div>
      <div class="column-list" id="columnList2"></div>
    </div>
    <div class="group-section" id="controls-section" style="display:none;">
      <div class="group-title">Control Variables for Partial:</div>
      <div class="column-list" id="controlsList"></div>
    </div>
    <div class="actions">
      <button type="submit">Calculate</button>
      <button type="button" onclick="closePopup()">Cancel</button>
    </div>
    <div class="error" id="errorMsg"></div>
  </form>

  <script>
    function closePopup() {
      try { parent.closeModal(); } catch(e) { window.close(); }
    }
        function excelColLabel(index) {
          let label = '';
          let n = index;
          while (n >= 0) {
            label = String.fromCharCode(65 + (n % 26)) + label;
            n = Math.floor(n / 26) - 1;
          }
          return label;
        }

    function loadColumns() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const headersParam = urlParams.get('headers');
        if (headersParam) {
          const headers = JSON.parse(decodeURIComponent(headersParam));
          const mkCheckboxes = (listId) => {
            const listDiv = document.getElementById(listId);
            listDiv.innerHTML = headers.map((header, idx) =>
              `<label><input type="checkbox" name="${listId}" value="${idx}">
                ${excelColLabel(idx)}: ${header}</label>`).join('');
          };
          mkCheckboxes('columnList1');
          mkCheckboxes('columnList2');
          mkCheckboxes('controlsList');
        }
      } catch (e) {
        document.getElementById('columnList1').innerHTML = 'Error loading columns. Try again.';
        document.getElementById('columnList2').innerHTML = 'Error loading columns. Try again.';
      }
    }
    // Show/hide partial controls
    document.querySelectorAll('input[name="cor_method"]').forEach(el => {
      el.addEventListener('change', function() {
        document.getElementById('controls-section').style.display =
          this.value === 'partial' ? 'block' : 'none';
      });
    });

    // // Submit handler
    // document.getElementById('correlationForm').onsubmit = function(e) {
    //   e.preventDefault();
    //   const method = document.querySelector('input[name="cor_method"]:checked').value;
    //   const group1 = Array.from(document.querySelectorAll('input[name="columnList1"]:checked')).map(x=>parseInt(x.value));
    //   const group2 = Array.from(document.querySelectorAll('input[name="columnList2"]:checked')).map(x=>parseInt(x.value));
    //   const controls = Array.from(document.querySelectorAll('input[name="controlsList"]:checked')).map(x=>parseInt(x.value));
    //   const errorMsg = document.getElementById('errorMsg');
    //   errorMsg.style.display = 'none';

    //   if (method==="partial" && controls.length===0) {
    //     errorMsg.textContent="Select at least one control variable for Partial correlation.";
    //     errorMsg.style.display='block'; return;
    //   }
    //   if (group1.length===0) {
    //     errorMsg.textContent="Select at least one variable in Group 1.";
    //     errorMsg.style.display='block'; return;
    //   }
    //   if (method==="bivariate" && group2.length===0 && group1.length<2) {
    //     errorMsg.textContent="Select at least two variables in Group 1 or pick Group 2.";
    //     errorMsg.style.display='block'; return;
    //   }
    //   parent.runCalculation("correlation", {
    //     method: method,
    //     group1: group1,
    //     group2: group2,
    //     controls: controls
    //   });
    // };

    document.getElementById('correlationForm').onsubmit = function(e) {
        e.preventDefault();
        const method = document.querySelector('input[name="cor_method"]:checked').value;
        const group1 = Array.from(document.querySelectorAll('input[name="columnList1"]:checked'))
                            .map(x=>parseInt(x.value));
        const group2 = Array.from(document.querySelectorAll('input[name="columnList2"]:checked'))
                            .map(x=>parseInt(x.value));
        const controls = Array.from(document.querySelectorAll('input[name="controlsList"]:checked'))
                                .map(x=>parseInt(x.value));
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.style.display = 'none';

        if (method==="partial" && controls.length===0) {
            errorMsg.textContent="Select at least one control variable.";
            errorMsg.style.display='block'; return;
        }
        if (group1.length===0) {
            errorMsg.textContent="Select ≥1 variable in Group 1.";
            errorMsg.style.display='block'; return;
        }
        if (method==="bivariate" && group2.length===0 && group1.length<2) {
            errorMsg.textContent="Select ≥2 vars in Group 1 or pick Group 2.";
            errorMsg.style.display='block'; return;
        }

        // Pass parameters in additionalData, leave columns empty
        parent.runCalculation('correlation', [], {
            method: method,
            group1: group1,
            group2: group2,
            controls: controls
        });
    };


    window.onload=loadColumns;
  </script>
  <div class="popup-close" onclick="closePopup()">✕</div>
</body>
</html> -->




<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Correlation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #fff;
    }
    h3 { color: #1976d2; margin-top: 0; }
    .group-title { font-weight: bold; margin-bottom: 10px; font-size: 16px; }
    .group-section { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #f7f7f7;}
    .column-list { max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff;}
    .column-list label { display: block; margin-bottom: 8px; padding: 4px; cursor: pointer;}
    .column-list label:hover { background: #e3f2fd; }
    .method-section { margin-bottom: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px;}
    .actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;}
    button { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px;}
    button[type="submit"] { background: #1976d2; color: white; border-color: #1976d2;}
    button[type="submit"]:hover { background: #1565c0;}
    .error { color: #d32f2f; margin-top: 10px; padding: 8px; background: #ffebee; border-radius: 4px; display: none;}
    .info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px;}
    .popup-close { position: absolute; top: 12px; right: 16px; font-size: 20px; color: #555; cursor: pointer;}
    .popup-close:hover { color: #000;}
  </style>
</head>
<body>
  <h3>Correlation Analysis</h3>
  <div class="info">
    Select method and columns for analysis.<br>
    <b>Bivariate:</b> Pearson or Spearman correlation; <b>Partial:</b> controls for extra variables; 
    <b>Distances:</b> computes Case-wise or Variable-wise distances.<br>
    You can select multiple columns for advanced methods.
  </div>

  <form id="correlationForm">
    <div class="method-section">
      <div style="font-weight: bold;">Analysis Type:</div>
      <label><input type="radio" name="cor_method" value="bivariate" checked> Bivariate</label>
      <div id="bivariate-options" style="margin-left:20px; display:block;">
        <label><input type="radio" name="bivar_type" value="pearson" checked> Pearson</label>
        <label><input type="radio" name="bivar_type" value="spearman"> Spearman</label>
      </div>

      <label><input type="radio" name="cor_method" value="partial"> Partial</label>

      <label><input type="radio" name="cor_method" value="distances"> Distances</label>
      <div id="distance-options" style="margin-left:20px; display:none;">
        <label><input type="radio" name="dist_type" value="casewise" checked> Case-wise</label>
        <label><input type="radio" name="dist_type" value="varwise"> Variable-wise</label>
      </div>
    </div>

    <div class="group-section">
      <div class="group-title">Variables Group 1:</div>
      <div class="column-list" id="columnList1"></div>
    </div>
    <div class="group-section">
      <div class="group-title">Variables Group 2 (optional):</div>
      <div class="column-list" id="columnList2"></div>
    </div>
    <div class="group-section" id="controls-section" style="display:none;">
      <div class="group-title">Control Variables for Partial:</div>
      <div class="column-list" id="controlsList"></div>
    </div>
    <div class="actions">
      <button type="submit">Calculate</button>
      <button type="button" onclick="closePopup()">Cancel</button>
    </div>
    <div class="error" id="errorMsg"></div>
  </form>

  <script>
    function closePopup() {
      try { parent.closeModal(); } catch(e) { window.close(); }
    }
    function excelColLabel(index) {
      let label = '';
      let n = index;
      while (n >= 0) {
        label = String.fromCharCode(65 + (n % 26)) + label;
        n = Math.floor(n / 26) - 1;
      }
      return label;
    }
    function loadColumns() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const headersParam = urlParams.get('headers');
        if (headersParam) {
          const headers = JSON.parse(decodeURIComponent(headersParam));
          const mkCheckboxes = (listId) => {
            const listDiv = document.getElementById(listId);
            listDiv.innerHTML = headers.map((header, idx) =>
              `<label><input type="checkbox" name="${listId}" value="${idx}">
                ${excelColLabel(idx)}: ${header}</label>`).join('');
          };
          mkCheckboxes('columnList1');
          mkCheckboxes('columnList2');
          mkCheckboxes('controlsList');
        }
      } catch (e) {
        document.getElementById('columnList1').innerHTML = 'Error loading columns. Try again.';
        document.getElementById('columnList2').innerHTML = 'Error loading columns. Try again.';
      }
    }

    // Show/hide options
    document.querySelectorAll('input[name="cor_method"]').forEach(el => {
      el.addEventListener('change', function() {
        document.getElementById('controls-section').style.display =
          this.value === 'partial' ? 'block' : 'none';
        document.getElementById('bivariate-options').style.display =
          this.value === 'bivariate' ? 'block' : 'none';
        document.getElementById('distance-options').style.display =
          this.value === 'distances' ? 'block' : 'none';
      });
    });

    document.getElementById('correlationForm').onsubmit = function(e) {
        e.preventDefault();
        const method = document.querySelector('input[name="cor_method"]:checked').value;
        let submethod = null;
        if (method === "bivariate") {
          submethod = document.querySelector('input[name="bivar_type"]:checked').value;
        }
        if (method === "distances") {
          submethod = document.querySelector('input[name="dist_type"]:checked').value;
        }

        const group1 = Array.from(document.querySelectorAll('input[name="columnList1"]:checked')).map(x=>parseInt(x.value));
        const group2 = Array.from(document.querySelectorAll('input[name="columnList2"]:checked')).map(x=>parseInt(x.value));
        const controls = Array.from(document.querySelectorAll('input[name="controlsList"]:checked')).map(x=>parseInt(x.value));
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.style.display = 'none';

        if (method==="partial" && controls.length===0) {
            errorMsg.textContent="Select at least one control variable.";
            errorMsg.style.display='block'; return;
        }
        if (group1.length===0) {
            errorMsg.textContent="Select ≥1 variable in Group 1.";
            errorMsg.style.display='block'; return;
        }
        if (method==="bivariate" && group2.length===0 && group1.length<2) {
            errorMsg.textContent="Select ≥2 vars in Group 1 or pick Group 2.";
            errorMsg.style.display='block'; return;
        }

        parent.runCalculation('correlation', [], {
            method: method,
            submethod: submethod,
            group1: group1,
            group2: group2,
            controls: controls
        });
    };
    window.onload=loadColumns;
  </script>
  <div class="popup-close" onclick="closePopup()">✕</div>
</body>
</html>
