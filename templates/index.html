<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jasper Colin Project</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@15.3.0/dist/handsontable.min.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; }
    .menu-bar {
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 0;
      display: flex; align-items: center; min-height: 56px;
      border-bottom: 1px solid #eaeaea; z-index: 100; position: relative;
    }
    .menu-logo { height: 32px; margin: 0 18px 0 12px; width: auto; vertical-align: middle; margin-right: 20px; }
    .menu-title { font-weight: bold; font-size: 18px; margin-right: 40px; }
    #menus { display: flex; }
    .menu-group { position: relative; margin-right: 32px; }
    .dropdown { cursor: pointer; padding: 10px 14px; background: none; border: none; font-size: 16px; color: #222; border-radius: 4px;}
    .dropdown:hover, .dropdown:focus { background: #e3f2fd; }
    .dropdown-content { display: none; position: absolute; top: 42px; left: 0; background: #fff; min-width: 200px; box-shadow: 0 4px 20px #0002; z-index: 1000; border-radius: 4px; padding: 8px 0;}
    .menu-group:hover .dropdown-content, .menu-group:focus-within .dropdown-content { display: block; }
    .dropdown-content button { display: block; width: 100%; background: none; border: none; padding: 8px 22px; text-align: left; font-size: 15px; color: #1976d2; cursor: pointer;}
    .dropdown-content button:hover { background: #e3f2fd; color: #004ba0; }
    .submenu-group { position:relative; }
    .submenu-content { display:none; position: absolute; left:100%; top:0; min-width:170px; background:#fff; box-shadow:0 4px 20px #0002; border-radius:4px; padding:7px 0; z-index:1100;}
    .dropdown-content .submenu-group:hover .submenu-content { display: block;}
    .main-flex-wrapper { display: flex; align-items: flex-start; gap: 12px;}
    #hot { position: relative; margin: 28px auto 0 auto; width: auto !important; max-width: 1100px; z-index: 1 !important; }
    #result {position: relative; z-index: 2; flex: 0 0 300px; max-width: 420px; min-width: 270px; overflow: auto; height: calc(100vh - 96px); font-weight: bold; margin-top: 16px; margin-left: 6px; min-height: 20px; padding: 20px; background: #f5f5f5; border-radius: 4px; }
    #version { margin-left: auto; margin-right: 20px; font-size: 13px; color: #777; }
    #modal { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;}
    #modal iframe { background:#fff; border-radius:8px; border:none; width:500px; height:400px; }
    #fileInput { display: none; }
    .loading { color: #666; font-style: italic; }



    /* Container for all results */
    #result h4 {
      font-family: Arial, sans-serif;
      color: #1976d2;
      margin-bottom: 8px;
    }

    /* Each result block */
    .result-block {
      border-left: 1px solid #1976d2;
      border-right: 1px solid #1976d2;
      border-bottom: 1px solid #1976d2;
      padding: 8px 12px;
      font-family: Consolas, monospace;
      font-size: 14px;
      white-space: pre-line;  /* preserve newline formatting */
      margin: 0;
    }

    /* Top and bottom borders on the first and last lines */
    .result-block:first-child {
      border-top: 1px solid #1976d2;
    }
    .result-block:last-child {
      border-bottom: 1px solid #1976d2;
    }

    /* Separator between blocks */
    .result-block + .result-block {
      margin-top: 6px;
      padding-top: 12px;
    }


  </style>
</head>
<body>
  <div class="menu-bar">
    <img id="logo" src="static/logo.png" alt="Logo" class="menu-logo">
    <span class="menu-title">Jasper Colin Project</span>
    <div id="menus"></div>
    <span id="version">v1.0.0</span>
  </div>
  
  <input type="file" id="fileInput" accept=".xlsx,.xls">

  <!-- <div style="display: flex; align-items: flex-start;">
  <div id="result" style="min-width:270px; max-width:420px; margin-right:20px;"></div>
  <div style="flex:1;">
    <div id="hot"></div>
  </div>
</div> -->

<div class="main-flex-wrapper">
  <div id="result"></div>
  <div style="flex:1;">
    <div id="hot"></div>
  </div>
</div>

  <!-- <div id="hot"></div>
  <div id="result"></div> -->

  <div id="modal">
    <iframe id="popup-frame" src=""></iframe>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@15.3.0/dist/handsontable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    let resultsHistory = [];
    // Complete SPSS Menu Configuration
    const menuConfig = [
      {
        label: "File",
        items: [
          // {text: "New", submenu: [
          //   {text: "Data", action: ()=>showCalculationPopup('new_data')},
          //   {text: "Syntax", action: ()=>showCalculationPopup('new_syntax')},
          //   {text: "Output", action: ()=>showCalculationPopup('new_output')},
          //   {text: "Script", action: ()=>showCalculationPopup('new_script')}
          // ]},
          {text: "Open", submenu: [
            {text: "Data", action: ()=>document.getElementById('fileInput').click()},
            // {text: "Syntax", action: ()=>showCalculationPopup('open_syntax')},
            // {text: "Output", action: ()=>showCalculationPopup('open_output')},
            // {text: "Script", action: ()=>showCalculationPopup('open_script')}
          ]},
          // {text: "Save", action: ()=>saveData()},
          // {text: "Export", action: ()=>exportData()},
          { text: "Export", action: ()=>exportAllResults() },
          {text: "Exit", action: ()=>window.close()}
        ]
      },
      {
        label: "Analysis",
        items: [
          {text: "Descriptive Statistics", submenu: [
            // {text: "Frequencies", action: ()=>showCalculationPopup('frequencies')},
            // {text: "Descriptives", action: ()=>showCalculationPopup('descriptives')},
            {text: "Mean", action: ()=>showCalculationPopup('mean')},
            {text: "Median", action: ()=>showCalculationPopup('median')},
            {text: "Mode", action: ()=>showCalculationPopup('mode')},
            // {text: "Explore", action: ()=>showCalculationPopup('explore')}
          ]},
          // {text: "Compare Means", submenu: [
          //   {text: "Means", action: ()=>showCalculationPopup('means')},
          //   {text: "T-Test", action: ()=>showCalculationPopup('ttest')},
          //   {text: "One-Way ANOVA", action: ()=>showCalculationPopup('anova')}
          // ]},
          {text: "Correlation", submenu: [
            {text: "Bivariate/Partial/Distances", action: ()=>showCalculationPopup('correlation')},
            // {text: "Partial", action: ()=>showCalculationPopup('partial_correlation')},
            // {text: "Distance", action: ()=>showCalculationPopup('distances_correlation')}
          ]},

          // {text: "Regression", submenu: [
          //   {text: "Linear", action: ()=>showCalculationPopup('linear_regression')},
          //   {text: "Logistic", action: ()=>showCalculationPopup('logistic_regression')}
          // ]}
        ]
      },
      // {
      //   label: "Graphs",
      //   items: [
      //     {text: "Chart Builder", action: ()=>showCalculationPopup('chart_builder')},
      //     {text: "Legacy Dialogs", submenu: [
      //       {text: "Bar", action: ()=>showCalculationPopup('bar_chart')},
      //       {text: "Line", action: ()=>showCalculationPopup('line_chart')},
      //       {text: "Histogram", action: ()=>showCalculationPopup('histogram')},
      //       {text: "Scatter", action: ()=>showCalculationPopup('scatter_plot')}
      //     ]}
      //   ]
      // }
    ];

    // Handsontable initializatio n
    let hot;
    function createGridEmpty(rows=10, cols=20) {
      hot = new Handsontable(document.getElementById('hot'), {
        data: Array(rows).fill().map(() => Array(cols).fill("")),
        minRows: -1, minCols: 1,
        rowHeaders: true,
        colHeaders: true,
        contextMenu: true,
        manualRowResize: true,
        manualColumnResize: true,
        licenseKey: 'non-commercial-and-evaluation',
        copyPaste: true,
      });
    }
    createGridEmpty();

    // Build menu system
    function buildMenus(config) {
      const menuDiv = document.getElementById('menus');
      menuDiv.innerHTML = '';
      config.forEach(menu => {
        let group = document.createElement('div');
        group.className = "menu-group";
        const btn = document.createElement('button');
        btn.className = "dropdown";
        btn.textContent = menu.label + " â–¾";
        group.appendChild(btn);

        let dd = document.createElement('div');
        dd.className = "dropdown-content";
        menu.items.forEach(item => {
          if(item.submenu) {
            let smgroup = document.createElement('div');
            smgroup.className = "submenu-group";
            const smbtn = document.createElement('button');
            smbtn.textContent = item.text + " â–¶";
            smgroup.appendChild(smbtn);

            let smdd = document.createElement('div');
            smdd.className = "submenu-content";
            item.submenu.forEach(subitem => {
              let smBtn = document.createElement('button');
              smBtn.textContent = subitem.text;
              smBtn.onclick = subitem.action;
              smdd.appendChild(smBtn);
            });
            smgroup.appendChild(smdd);
            dd.appendChild(smgroup);
          } else {
            const b = document.createElement('button');
            b.textContent = item.text;
            b.onclick = item.action;
            dd.appendChild(b);
          }
        });
        group.appendChild(dd);
        menuDiv.appendChild(group);
      });
    }
    buildMenus(menuConfig);

    // Show calculation popup from calculations folder
    // function showCalculationPopup(calculationType) {
    //   const modal = document.getElementById('modal');
    //   const iframe = document.getElementById('popup-frame');
    //   iframe.src = `calculations/${calculationType}.html`;
    //   modal.style.display = 'flex';
    // }

    // Show calculation popup with column data
    function showCalculationPopup(calculationType) {
      const modal = document.getElementById('modal');
      const iframe = document.getElementById('popup-frame');      
      // Get column headers and pass them as URL parameters
      const colHeaders = hot.getColHeader();
      const encodedHeaders = encodeURIComponent(JSON.stringify(colHeaders));
      
      iframe.src = `/calculations/${calculationType}.html?headers=${encodedHeaders}`;
      modal.style.display = 'flex';
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // This function will be called by popup iframes
    window.runCalculation = async function(calcType, selectedColumns, additionalData = {}) {
      try {
        document.getElementById('result').innerHTML = '<div class="loading">Calculating...</div>';

        // Get data from grid
        const gridData = [];
        for(let r = 1; r < hot.countRows(); r++) {
          const row = [];
          for(let c = 0; c < hot.countCols(); c++) {
            row.push(hot.getDataAtCell(r, c));
          }
          gridData.push(row);
        }

        // Send to backend
        const response = await fetch('/api/calculate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            calculation_type: calcType,
            data: gridData,
            columns: selectedColumns,
            headers: hot.getColHeader(),
            additional_data: additionalData
          })
        });

        const result = await response.json();
        
        if(result.success) {

          if (calcType.toLowerCase() === 'correlation') {
            renderCorrelationMatrix(result.result);
          } else {
          
            function renderResults(calcType, rawHtml) {
              // Build the header
              let html = `<h4> ${calcType.toUpperCase()} Results:</h4>`;

              // rawHtml already contains each column's <div>â€¦</div>
              // Wrap each in your simple box styling:
              const temp = document.createElement('div');
              temp.innerHTML = rawHtml.trim();

              // For each child DIV, grab its innerText and wrap it
              Array.from(temp.children).forEach(child => {
                const text = child.innerText.trim().replace(/\n/g, '<br>');
                html += `<div class="result-block">${text}</div>`;
              });

              // Finally inject
              document.getElementById('result').innerHTML = html;
            }

            // In your runCalculation success block:
            if (result.success) {
              renderResults(calcType, result.result);
              resultsHistory.push({ type: calcType, output_html: result.result });
              closeModal();
            }
          }
        }
        // ensure modal closed
        closeModal();
      } catch(error) {
        document.getElementById('result').innerHTML = `
          <div style="color: red;">Calculation failed: ${error.message}</div>
        `;
      }
    };

    document.getElementById('fileInput').onchange = (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: "array"});
        const wsname = workbook.SheetNames;
        const ws = workbook.Sheets[wsname];
        const sheetData = XLSX.utils.sheet_to_json(ws, {header:1});
        hot.loadData(sheetData);
      };
      reader.readAsArrayBuffer(file);
    };


    function saveData() {
      const data = hot.getData();
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      XLSX.writeFile(wb, "spss_data.xlsx");
    }

    function exportData() {
      alert("Export functionality coming soon!");
    }


    async function exportAllResults() {
      if (!resultsHistory.length) {
        alert("There is No results to export.");
        return;
      }
      try {
        const resp = await fetch('/api/export', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ history: resultsHistory })
        });
        if (!resp.ok) throw new Error("Export failed");
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'analysis_results.xlsx';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
      } catch (e) {
        alert("Export error: " + e.message);
      }
    }

  </script>

    <script>
   
    // New renderCorrelationMatrix: insert server HTML as-is and push to resultsHistory so export finds it.
    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function renderCorrelationMatrix(rawHtml) {
      const container = document.getElementById("result");
      if (!rawHtml || !rawHtml.trim()) {
        container.innerHTML = "<p>No correlation matrix data.</p>";
        return;
      }

      // If server returned HTML markup, inject it directly so tables and formatting remain intact.
      if (/<\/?[a-z][\s\S]*>/i.test(rawHtml)) {
        container.innerHTML = rawHtml;
      } else {
        // fallback: show raw text in preformatted block
        container.innerHTML = '<h4>Correlation Matrix</h4><pre style="font-family:monospace;white-space:pre-wrap;">' + escapeHtml(rawHtml) + '</pre>';
      }

      // Save to resultsHistory for export (avoid duplicating identical last entry)
      try {
        const last = resultsHistory.length ? resultsHistory[resultsHistory.length - 1] : null;
        if (!last || last.type !== 'correlation' || last.output_html !== rawHtml) {
          resultsHistory.push({
            type: 'correlation',
            output_html: rawHtml,
            grid_data: (window.hot && window.hot.getData) ? window.hot.getData() : null,
            headers: (window.hot && window.hot.getColHeader) ? window.hot.getColHeader() : null
          });
        }
      } catch (e) {
        console.warn('Could not save correlation to history:', e);
      }
    }
  

  // Generic render function â€“ calls correlation matrix renderer if type is correlation
  function renderResults(calcType, rawText) {
    if (calcType.toLowerCase() === 'correlation') {
      renderCorrelationMatrix(rawText);
    } else {
      const container = document.getElementById("result");
      if (!rawText || !rawText.trim()) {
        container.innerHTML = "<p>No results available.</p>";
        return;
      }
      const temp = document.createElement('div');
      temp.innerHTML = rawText.trim();
      let html = `<h4>ðŸ“Š ${calcType.toUpperCase()} Results</h4>`;
      Array.from(temp.children).forEach(div => {
        const lines = div.innerText.trim().split('\n').filter(l => l);
        html += `<div style="margin-bottom:20px; padding-left:10px; border-left:4px solid #1976d; font-family: monospace; font-size:14px;">`;
        lines.forEach(line => {
          const parts = line.split(':');
          if(parts.length > 1){
            html += `<strong>${parts[0].trim()}:</strong> ${parts.slice(1).join(':').trim()}<br>`;
          } else {
            html += `${line}<br>`;
          }
        });
        html += "</div>";
      });
      container.innerHTML = html;
    }
  }

  </script>

<!-- for Copy the data in grid s -->

  <script>
  (function installHandsontablePasteHandler() {

    // normalize a pasted cell: convert plain numeric strings to Number, remove thousands commas
    function normalizePastedCell(v) {
      if (v === null || v === undefined) return null;
      const s = String(v).trim();
      if (s === '') return null;
      // remove common thousands separators, then check numeric
      const sNoComma = s.replace(/,/g, '');
      if (!isNaN(sNoComma) && sNoComma !== '') return Number(sNoComma);
      return s;
    }

    // parse a clipboard row into columns (prefer TSV, fallback to CSV)
    function parseRowToCells(row) {
      let cells = row.split('\t');
      if (cells.length === 1) {
        // no tabs found â€” try comma separation (CSV-like)
        cells = row.split(',');
      }
      return cells;
    }

    document.addEventListener('paste', function(e) {
      try {
        if (!window.hot) return;                    // no grid
        const container = document.getElementById('hot');
        if (!container) return;
        // Only intercept paste if the active element is inside our grid container
        if (!container.contains(document.activeElement)) return;

        const clipboardData = (e.clipboardData || window.clipboardData);
        if (!clipboardData) return;
        const text = clipboardData.getData('text');
        if (!text) return;

        // prevent the browser / Handsontable default paste handling
        e.preventDefault();

        // parse rows (handle CRLF/LF)
        const rows = text.split(/\r\n|\n|\r/).filter(r => r.length > 0);
        if (!rows.length) return;

        // determine starting cell from Handsontable selection
        // hot.getSelected() returns an array of selections: [[startRow, startCol, endRow, endCol], ...]
        let sel = hot.getSelected && hot.getSelected();
        let startRow = 0, startCol = 0;
        if (Array.isArray(sel) && sel.length && Array.isArray(sel[0])) {
          startRow = sel[0][0];
          startCol = sel[0][1];
        } else {
          // fallback: place at (0,0)
          startRow = 0; startCol = 0;
        }

        // Paste each parsed cell into the grid, expanding grid if necessary
        for (let r = 0; r < rows.length; r++) {
          let cells = parseRowToCells(rows[r]);
          for (let c = 0; c < cells.length; c++) {
            const rr = startRow + r;
            const cc = startCol + c;

            // expand rows if paste goes beyond current grid
            if (rr >= hot.countRows()) {
              // insert rows at end
              hot.alter('insert_row', hot.countRows(), rr - hot.countRows() + 1);
            }
            // expand cols if paste beyond current grid
            if (cc >= hot.countCols()) {
              hot.alter('insert_col', hot.countCols(), cc - hot.countCols() + 1);
            }

            const rawVal = cells[c];
            const normalized = normalizePastedCell(rawVal);
            // use setDataAtCell to trigger Handsontable change logic; provide 'paste' source tag
            hot.setDataAtCell(rr, cc, normalized, 'paste');
          }
        }
      } catch (err) {
        // don't break UI on unexpected errors â€” log in console for debugging
        console.error('Paste handler error:', err);
      }
    }, false);

  })();
  </script>

</body>
</html>
