<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jasper Colin Project</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@15.3.0/dist/handsontable.min.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; }
    .menu-bar {
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 0;
      display: flex; align-items: center; min-height: 56px;
      border-bottom: 1px solid #eaeaea; z-index: 100; position: relative;
    }
    .menu-logo { height: 38px; margin: 0 18px 0 12px; }
    .menu-title { font-weight: bold; font-size: 18px; margin-right: 40px; }
    #menus { display: flex; }
    .menu-group { position: relative; margin-right: 32px; }
    .dropdown { cursor: pointer; padding: 10px 14px; background: none; border: none; font-size: 16px; color: #222; border-radius: 4px;}
    .dropdown:hover, .dropdown:focus { background: #e3f2fd; }
    .dropdown-content { display: none; position: absolute; top: 42px; left: 0; background: #fff; min-width: 200px; box-shadow: 0 4px 20px #0002; z-index: 1000; border-radius: 4px; padding: 8px 0;}
    .menu-group:hover .dropdown-content, .menu-group:focus-within .dropdown-content { display: block; }
    .dropdown-content button { display: block; width: 100%; background: none; border: none; padding: 8px 22px; text-align: left; font-size: 15px; color: #1976d2; cursor: pointer;}
    .dropdown-content button:hover { background: #e3f2fd; color: #004ba0; }
    .submenu-group { position:relative; }
    .submenu-content { display:none; position: absolute; left:100%; top:0; min-width:170px; background:#fff; box-shadow:0 4px 20px #0002; border-radius:4px; padding:7px 0; z-index:1100;}
    .dropdown-content .submenu-group:hover .submenu-content { display: block;}
    #hot { margin: 28px auto 0 auto; width: 95%; max-width: 1100px; z-index: 1 !important; }
    #result { font-weight: bold; margin-top: 16px; margin-left: 6px; min-height: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; }
    #version { margin-left: auto; margin-right: 36px; font-size: 13px; color: #777; }
    #modal { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;}
    #modal iframe { background:#fff; border-radius:8px; border:none; width:500px; height:400px; }
    #fileInput { display: none; }
    .loading { color: #666; font-style: italic; }



    /* Container for all results */
    #result h4 {
      font-family: Arial, sans-serif;
      color: #1976d2;
      margin-bottom: 8px;
    }

    /* Each result block */
    .result-block {
      border-left: 1px solid #1976d2;
      border-right: 1px solid #1976d2;
      border-bottom: 1px solid #1976d2;
      padding: 8px 12px;
      font-family: Consolas, monospace;
      font-size: 14px;
      white-space: pre-line;  /* preserve newline formatting */
      margin: 0;
    }

    /* Top and bottom borders on the first and last lines */
    .result-block:first-child {
      border-top: 1px solid #1976d2;
    }
    .result-block:last-child {
      border-bottom: 1px solid #1976d2;
    }

    /* Separator between blocks */
    .result-block + .result-block {
      margin-top: 6px;
      padding-top: 12px;
    }


  </style>
</head>
<body>
  <div class="menu-bar">
    <img id="logo" src="static/logo.png" alt="Logo" class="menu-logo">
    <span class="menu-title">Jasper Colin Project</span>
    <div id="menus"></div>
    <span id="version">v1.0.0</span>
  </div>
  
  <input type="file" id="fileInput" accept=".xlsx,.xls">

  <div style="display: flex; align-items: flex-start;">
  <div id="result" style="min-width:270px; max-width:420px; margin-right:20px;"></div>
  <div style="flex:1;">
    <div id="hot"></div>
  </div>
</div>

  <!-- <div id="hot"></div>
  <div id="result"></div> -->

  <div id="modal">
    <iframe id="popup-frame" src=""></iframe>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@15.3.0/dist/handsontable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    let resultsHistory = [];
    // Complete SPSS Menu Configuration
    const menuConfig = [
      {
        label: "File",
        items: [
          // {text: "New", submenu: [
          //   {text: "Data", action: ()=>showCalculationPopup('new_data')},
          //   {text: "Syntax", action: ()=>showCalculationPopup('new_syntax')},
          //   {text: "Output", action: ()=>showCalculationPopup('new_output')},
          //   {text: "Script", action: ()=>showCalculationPopup('new_script')}
          // ]},
          {text: "Open", submenu: [
            {text: "Data", action: ()=>document.getElementById('fileInput').click()},
            // {text: "Syntax", action: ()=>showCalculationPopup('open_syntax')},
            // {text: "Output", action: ()=>showCalculationPopup('open_output')},
            // {text: "Script", action: ()=>showCalculationPopup('open_script')}
          ]},
          // {text: "Save", action: ()=>saveData()},
          // {text: "Export", action: ()=>exportData()},
          { text: "Export", action: ()=>exportAllResults() },
          {text: "Exit", action: ()=>window.close()}
        ]
      },
      {
        label: "Analysis",
        items: [
          {text: "Descriptive Statistics", submenu: [
            // {text: "Frequencies", action: ()=>showCalculationPopup('frequencies')},
            // {text: "Descriptives", action: ()=>showCalculationPopup('descriptives')},
            {text: "Mean", action: ()=>showCalculationPopup('mean')},
            {text: "Median", action: ()=>showCalculationPopup('median')},
            {text: "Mode", action: ()=>showCalculationPopup('mode')},
            // {text: "Explore", action: ()=>showCalculationPopup('explore')}
          ]},
          // {text: "Compare Means", submenu: [
          //   {text: "Means", action: ()=>showCalculationPopup('means')},
          //   {text: "T-Test", action: ()=>showCalculationPopup('ttest')},
          //   {text: "One-Way ANOVA", action: ()=>showCalculationPopup('anova')}
          // ]},
          {text: "Correlate", submenu: [
            {text: "Bivariate/Partial/Distances", action: ()=>showCalculationPopup('correlation')},
            // {text: "Partial", action: ()=>showCalculationPopup('partial_correlation')},
            // {text: "Distance", action: ()=>showCalculationPopup('distances_correlation')}
          ]},

          // {text: "Regression", submenu: [
          //   {text: "Linear", action: ()=>showCalculationPopup('linear_regression')},
          //   {text: "Logistic", action: ()=>showCalculationPopup('logistic_regression')}
          // ]}
        ]
      },
      // {
      //   label: "Graphs",
      //   items: [
      //     {text: "Chart Builder", action: ()=>showCalculationPopup('chart_builder')},
      //     {text: "Legacy Dialogs", submenu: [
      //       {text: "Bar", action: ()=>showCalculationPopup('bar_chart')},
      //       {text: "Line", action: ()=>showCalculationPopup('line_chart')},
      //       {text: "Histogram", action: ()=>showCalculationPopup('histogram')},
      //       {text: "Scatter", action: ()=>showCalculationPopup('scatter_plot')}
      //     ]}
      //   ]
      // }
    ];

    // Handsontable initializatio n
    let hot;
    function createGridEmpty(rows=2, cols=80) {
      hot = new Handsontable(document.getElementById('hot'), {
        data: Array(rows).fill().map(() => Array(cols).fill("")),
        minRows: -1, minCols: 1,
        rowHeaders: true,
        colHeaders: Array(cols).fill().map((_, i) => String.fromCharCode(65 + i)),
        contextMenu: true,
        manualRowResize: true,
        manualColumnResize: true,
        licenseKey: 'non-commercial-and-evaluation',
        copyPaste: true,
      });
    }
    createGridEmpty();

    // Build menu system
    function buildMenus(config) {
      const menuDiv = document.getElementById('menus');
      menuDiv.innerHTML = '';
      config.forEach(menu => {
        let group = document.createElement('div');
        group.className = "menu-group";
        const btn = document.createElement('button');
        btn.className = "dropdown";
        btn.textContent = menu.label + " â–¾";
        group.appendChild(btn);

        let dd = document.createElement('div');
        dd.className = "dropdown-content";
        menu.items.forEach(item => {
          if(item.submenu) {
            let smgroup = document.createElement('div');
            smgroup.className = "submenu-group";
            const smbtn = document.createElement('button');
            smbtn.textContent = item.text + " â–¶";
            smgroup.appendChild(smbtn);

            let smdd = document.createElement('div');
            smdd.className = "submenu-content";
            item.submenu.forEach(subitem => {
              let smBtn = document.createElement('button');
              smBtn.textContent = subitem.text;
              smBtn.onclick = subitem.action;
              smdd.appendChild(smBtn);
            });
            smgroup.appendChild(smdd);
            dd.appendChild(smgroup);
          } else {
            const b = document.createElement('button');
            b.textContent = item.text;
            b.onclick = item.action;
            dd.appendChild(b);
          }
        });
        group.appendChild(dd);
        menuDiv.appendChild(group);
      });
    }
    buildMenus(menuConfig);

    // Show calculation popup from calculations folder
    // function showCalculationPopup(calculationType) {
    //   const modal = document.getElementById('modal');
    //   const iframe = document.getElementById('popup-frame');
    //   iframe.src = `calculations/${calculationType}.html`;
    //   modal.style.display = 'flex';
    // }

    // Show calculation popup with column data
    function showCalculationPopup(calculationType) {
      const modal = document.getElementById('modal');
      const iframe = document.getElementById('popup-frame');      
      // Get column headers and pass them as URL parameters
      const colHeaders = hot.getColHeader();
      const encodedHeaders = encodeURIComponent(JSON.stringify(colHeaders));
      
      iframe.src = `/calculations/${calculationType}.html?headers=${encodedHeaders}`;
      modal.style.display = 'flex';
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // This function will be called by popup iframes
    window.runCalculation = async function(calcType, selectedColumns, additionalData = {}) {
      try {
        document.getElementById('result').innerHTML = '<div class="loading">Calculating...</div>';


        // if (result.success) {
        //   // Save both grid data and result HTML
        //   resultsHistory.push({
        //     type: calcType,
        //     output_html: result.result,
        //     grid_data: hot.getData(),             // full 2D array snapshot
        //     headers: hot.getColHeader()           // header names
        //   });
        // }
        
        // Get data from grid
        const gridData = [];
        for(let r = 1; r < hot.countRows(); r++) {
          const row = [];
          for(let c = 0; c < hot.countCols(); c++) {
            row.push(hot.getDataAtCell(r, c));
          }
          gridData.push(row);
        }

        // Send to backend
        const response = await fetch('/api/calculate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            calculation_type: calcType,
            data: gridData,
            columns: selectedColumns,
            headers: hot.getColHeader(),
            additional_data: additionalData
          })
        });

        const result = await response.json();
        
        if(result.success) {

          if (calcType.toLowerCase() === 'correlation') {
            renderCorrelationMatrix(result.result);} 

          else {
          
            function renderResults(calcType, rawHtml) {
              // Build the header
              let html = `<h4> ${calcType.toUpperCase()} Results:</h4>`;

              // rawHtml already contains each column's <div>â€¦</div>
              // Wrap each in your simple box styling:
              const temp = document.createElement('div');
              temp.innerHTML = rawHtml.trim();

              // For each child DIV, grab its innerText and wrap it
              Array.from(temp.children).forEach(child => {
                const text = child.innerText.trim().replace(/\n/g, '<br>');
                html += `<div class="result-block">${text}</div>`;
              });

              // Finally inject
              document.getElementById('result').innerHTML = html;
            }

            // In your runCalculation success block:
            if (result.success) {
              renderResults(calcType, result.result);
              resultsHistory.push({ type: calcType, output_html: result.result });
              closeModal();
            }


            // document.getElementById('result').innerHTML = `
            //   <h4>${calcType.toUpperCase()} Results:</h4>
            //   <div>${result.result}</div>`;
            //   resultsHistory.push({
            //   type: calcType,
            //   output_html: result.result
            // });
          }

        
          // document.getElementById('result').innerHTML = `
          //   <div style="color: red;">Error: ${result.error}</div>
          // `;
        }
        
        closeModal();
      } catch(error) {
        document.getElementById('result').innerHTML = `
          <div style="color: red;">Calculation failed: ${error.message}</div>
        `;
      }
    };

    // File upload
    document.getElementById('fileInput').onchange = (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: "array"});
        const wsname = workbook.SheetNames;
        const ws = workbook.Sheets[wsname];
        const sheetData = XLSX.utils.sheet_to_json(ws, {header:1});
        hot.loadData(sheetData);
      };
      reader.readAsArrayBuffer(file);
    };

    // Utility functions
    function saveData() {
      const data = hot.getData();
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      XLSX.writeFile(wb, "spss_data.xlsx");
    }

    function exportData() {
      alert("Export functionality coming soon!");
    }



    async function exportAllResults() {
      if (!resultsHistory.length) {
        alert("There is No results to export.");
        return;
      }
      try {
        const resp = await fetch('/api/export', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ history: resultsHistory })
        });
        if (!resp.ok) throw new Error("Export failed");
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'analysis_results.xlsx';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
      } catch (e) {
        alert("Export error: " + e.message);
      }
    }

  </script>

    <script>
    // Function to render correlation results as a matrix
    function renderCorrelationMatrix(rawText) {
    // container to render matrix
    const container = document.getElementById("result");
    if (!rawText || !rawText.trim()) {
      container.innerHTML = "<p>No correlation matrix data.</p>";
      return;
    }

    // Parse your rawText and build a matrix table here
    // Example assumes rawText is CSV-like matrix data

    // Example: parsing raw text rows and columns
    const rows = rawText.trim().split('\n');
    let html = '<h4>Correlation Matrix</h4>';
    html += '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;">';

    rows.forEach(row => {
      html += '<tr>';
      const cols = row.split(/\s+/); // split by whitespace, change if needed
      cols.forEach(col => {
        html += `<td style="text-align:center;">${col}</td>`;
      });
      html += '</tr>';
    });

    html += '</table>';
    container.innerHTML = html;
  }
  

  // Generic render function â€“ calls correlation matrix renderer if type is correlation
  function renderResults(calcType, rawText) {
    if (calcType.toLowerCase() === 'correlation') {
      renderCorrelationMatrix(rawText);
    } else {
      const container = document.getElementById("result");
      if (!rawText || !rawText.trim()) {
        container.innerHTML = "<p>No results available.</p>";
        return;
      }
      const temp = document.createElement('div');
      temp.innerHTML = rawText.trim();
      let html = `<h4>ðŸ“Š ${calcType.toUpperCase()} Results</h4>`;
      Array.from(temp.children).forEach(div => {
        const lines = div.innerText.trim().split('\n').filter(l => l);
        html += `<div style="margin-bottom:20px; padding-left:10px; border-left:4px solid #1976d; font-family: monospace; font-size:14px;">`;
        lines.forEach(line => {
          const parts = line.split(':');
          if(parts.length > 1){
            html += `<strong>${parts[0].trim()}:</strong> ${parts.slice(1).join(':').trim()}<br>`;
          } else {
            html += `${line}<br>`;
          }
        });
        html += "</div>";
      });
      container.innerHTML = html;
    }
  }




  </script>


</body>
</html>
